<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Manual Graph Drawing App</title>
        <link rel="stylesheet" href="styles.css" />
        <!-- Add Lucide Icons - Local first, CDN fallback -->
        <script>
            // Try to load Lucide locally first, fallback to CDN
            (function () {
                const script = document.createElement("script");
                script.src = "lucide.min.js";
                script.onerror = function () {
                    // If local file fails, try CDN
                    const cdnScript = document.createElement("script");
                    cdnScript.src = "https://unpkg.com/lucide@latest";
                    cdnScript.onerror = function () {
                        // If both fail, mark Lucide as unavailable
                        window.lucideUnavailable = true;
                        console.warn(
                            "Lucide icons unavailable. Falling back to emojis.",
                        );
                    };
                    document.head.appendChild(cdnScript);
                };
                document.head.appendChild(script);
            })();
        </script>
        <!-- Add JSZip for ZIP file creation - CDN -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    </head>
    <body>
        <div class="app-container">
            <!-- Toolbar will be loaded here -->
            <div class="toolbar"></div>

            <div class="main-content">
                <div class="canvas-container">
                    <canvas id="graph-canvas" width="800" height="600"></canvas>
                    <!-- Dialogs will be loaded here -->
                </div>
                <!-- Sidebar will be loaded here -->
            </div>
        </div>

        <!-- Fullscreen exit button -->
        <button id="fullscreen-exit-btn" class="fullscreen-exit-btn">
            <i data-lucide="minimize-2" class="icon"></i>
            <span data-i18n="common.exitFullscreen">Exit Fullscreen</span>
        </button>

        <!-- Selection info popup -->
        <div id="selection-info-popup" class="selection-info-popup">
            <div class="selection-info-popup-header">
                <h3 data-i18n="common.nodeDetails">Node Details</h3>
                <button
                    class="selection-info-popup-close"
                    id="selection-info-popup-close"
                >
                    Ã—
                </button>
            </div>
            <div
                class="selection-info-popup-content"
                id="selection-info-popup-content"
            >
                <p data-i18n="common.nothingSelected">Nothing selected</p>
            </div>
        </div>

        <!-- Load Template Loader -->
        <script type="module">
            import { initializeTemplates } from "./utils/templateLoader.js";

            // Initialize templates when DOM is ready
            if (document.readyState === "loading") {
                document.addEventListener(
                    "DOMContentLoaded",
                    initializeTemplates,
                );
            } else {
                initializeTemplates();
            }
        </script>

        <!-- Load UI functions -->
        <script type="module" src="ui-functions.js"></script>

        <!-- Main Application -->
        <script type="module" src="graph.js"></script>
        <script type="module" src="app.js"></script>
        <!-- Initialize Lucide Icons with fallback -->
        <script>
            // Wait for Lucide to load, then initialize icons
            let initAttempts = 0;
            const maxAttempts = 50; // 5 seconds max wait

            function initializeLucideIcons() {
                initAttempts++;

                if (
                    window.lucide &&
                    typeof window.lucide.createIcons === "function"
                ) {
                    try {
                        lucide.createIcons();
                        console.log("Lucide icons initialized successfully");
                        return;
                    } catch (error) {
                        console.error(
                            "Error initializing Lucide icons:",
                            error,
                        );
                        fallbackToEmojis();
                        return;
                    }
                }

                if (window.lucideUnavailable) {
                    fallbackToEmojis();
                    return;
                }

                // Wait a bit more for script to load (up to max attempts)
                if (initAttempts < maxAttempts) {
                    setTimeout(initializeLucideIcons, 100);
                } else {
                    console.warn(
                        "Lucide icons timed out. Falling back to emojis.",
                    );
                    fallbackToEmojis();
                }
            }

            function fallbackToEmojis() {
                // Map Lucide icon names to emojis
                const emojiMap = {
                    x: "âœ•",
                    search: "ðŸ”",
                    save: "ðŸ’¾",
                    "hard-drive-download": "ðŸ’¾",
                    "undo-2": "â†¶",
                    "circle-dot": "âš«",
                    link: "ðŸ”—",
                    "link-2": "ðŸ”—",
                    "mouse-pointer-2": "ðŸ‘†",
                    command: "âŒ¨ï¸",
                    "folder-open": "ðŸ“‚",
                    "trash-2": "ðŸ—‘ï¸",
                    "rotate-cw": "â†º",
                    "git-merge": "ðŸ”—",
                    layers: "ðŸ“‹",
                    "layout-template": "ðŸ“„",
                    settings: "âš™ï¸",
                    "maximize-2": "â›¶",
                    "minimize-2": "â›¶",
                };

                // Replace all Lucide icons with emojis
                document
                    .querySelectorAll("[data-lucide]")
                    .forEach(function (el) {
                        const iconName = el.getAttribute("data-lucide");
                        const emoji = emojiMap[iconName] || "â€¢";
                        const span = document.createElement("span");
                        span.className = "icon";
                        span.textContent = emoji;
                        el.parentNode.replaceChild(span, el);
                    });

                console.log("Fell back to emoji icons");
            }

            // Start initialization after DOM is ready
            if (document.readyState === "loading") {
                document.addEventListener(
                    "DOMContentLoaded",
                    initializeLucideIcons,
                );
            } else {
                // Small delay to ensure scripts are loaded
                setTimeout(initializeLucideIcons, 50);
            }
        </script>
    </body>
</html>
