<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Manual Graph Drawing App</title>
        <link rel="stylesheet" href="styles.css" />
        <!-- Add Lucide Icons - Local first, CDN fallback -->
        <script>
            // Try to load Lucide locally first, fallback to CDN
            (function () {
                const script = document.createElement("script");
                script.src = "lucide.min.js";
                script.onerror = function () {
                    // If local file fails, try CDN
                    const cdnScript = document.createElement("script");
                    cdnScript.src = "https://unpkg.com/lucide@latest";
                    cdnScript.onerror = function () {
                        // If both fail, mark Lucide as unavailable
                        window.lucideUnavailable = true;
                        console.warn(
                            "Lucide icons unavailable. Falling back to emojis.",
                        );
                    };
                    document.head.appendChild(cdnScript);
                };
                document.head.appendChild(script);
            })();
        </script>
    </head>
    <body>
        <div class="app-container">
            <div class="toolbar">
                <div class="toolbar-section">
                    <div class="search-container" style="position: relative">
                        <div
                            style="display: flex; align-items: center; gap: 4px"
                        >
                            <input
                                type="text"
                                id="node-search"
                                placeholder="Search nodes..."
                                style="
                                    padding: 6px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 4px;
                                    font-size: 13px;
                                    width: 200px;
                                "
                            />
                            <button
                                id="clear-search-btn"
                                class="tool-btn"
                                title="Clear Search"
                                style="padding: 6px 10px; display: none"
                            >
                                <i data-lucide="x" class="icon"></i>
                            </button>
                            <button
                                id="search-dialog-btn"
                                class="tool-btn"
                                title="Open Search Dialog"
                            >
                                <i data-lucide="search" class="icon"></i>
                            </button>
                        </div>
                        <div
                            id="search-results"
                            class="search-dropdown hidden"
                        ></div>
                    </div>
                </div>

                <div class="toolbar-section">
                    <button
                        id="save-changes"
                        class="tool-btn"
                        title="Save Changes"
                        style="display: none"
                    >
                        <i data-lucide="save" class="icon"></i>
                        <span>Save Changes</span>
                    </button>
                    <button
                        id="discard-changes"
                        class="tool-btn"
                        title="Discard Changes"
                        style="display: none"
                    >
                        <i data-lucide="undo-2" class="icon"></i>
                        <span>Discard</span>
                    </button>
                </div>

                <div class="toolbar-section">
                    <button
                        id="node-mode"
                        class="tool-btn active"
                        title="Node Mode"
                    >
                        <i data-lucide="circle-dot" class="icon"></i>
                        <span>Node</span>
                    </button>
                    <button id="edge-mode" class="tool-btn" title="Edge Mode">
                        <i data-lucide="link" class="icon"></i>
                        <span>Edge</span>
                    </button>
                    <button
                        id="select-mode"
                        class="tool-btn"
                        title="Select Mode"
                    >
                        <i data-lucide="mouse-pointer-2" class="icon"></i>
                        <span>Select</span>
                    </button>
                    <button
                        id="hotkey-mode-btn"
                        class="tool-btn"
                        title="Hotkey Mode (Vim-like)"
                    >
                        <i data-lucide="command" class="icon"></i>
                        <span>Hotkey</span>
                    </button>
                </div>

                <div class="toolbar-section">
                    <button
                        id="load-btn"
                        class="tool-btn"
                        title="Load Database"
                    >
                        <i data-lucide="folder-open" class="icon"></i>
                        <span>Load</span>
                    </button>
                    <button id="save-as-btn" class="tool-btn" title="Save As">
                        <i data-lucide="save" class="icon"></i>
                        <span>Save As</span>
                    </button>
                    <button
                        id="clear-btn"
                        class="tool-btn danger"
                        title="Clear All"
                    >
                        <i data-lucide="trash-2" class="icon"></i>
                    </button>
                </div>
            </div>

            <div class="main-content">
                <div class="canvas-container">
                    <canvas id="graph-canvas" width="800" height="600"></canvas>
                    <div id="weight-dialog" class="dialog hidden">
                        <div class="dialog-content">
                            <h3>Set Edge Properties</h3>
                            <label>Weight:</label>
                            <input
                                type="number"
                                id="weight-input"
                                placeholder="Enter weight"
                                step="0.1"
                                min="0"
                            />
                            <label>Category:</label>
                            <input
                                type="text"
                                id="edge-category"
                                placeholder="Category (optional)"
                            />
                            <div style="margin: 15px 0; text-align: center">
                                <button
                                    id="reverse-edge-btn"
                                    class="tool-btn"
                                    style="
                                        background: #007bff;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        padding: 8px 16px;
                                        font-size: 12px;
                                    "
                                >
                                    <i data-lucide="rotate-cw" class="icon"></i>
                                    Reverse Direction
                                </button>
                            </div>
                            <div class="dialog-buttons">
                                <button id="weight-ok">OK</button>
                                <button id="weight-cancel">Cancel</button>
                                <button id="weight-delete" class="danger">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="node-dialog" class="dialog hidden">
                        <div class="dialog-content">
                            <h3>Edit Node</h3>
                            <input
                                type="text"
                                id="node-label"
                                placeholder="Node label (English)"
                            />
                            <input
                                type="text"
                                id="node-chinese"
                                placeholder="中文标签 (Chinese)"
                            />
                            <div
                                style="
                                    display: flex;
                                    gap: 8px;
                                    align-items: center;
                                "
                            >
                                <input
                                    type="color"
                                    id="node-color"
                                    value="#507F80"
                                />
                                <input
                                    type="text"
                                    id="node-color-hex"
                                    placeholder="#507F80"
                                    style="width: 80px; font-family: monospace"
                                />
                            </div>
                            <label>Position:</label>
                            <div
                                style="
                                    display: flex;
                                    gap: 8px;
                                    align-items: center;
                                "
                            >
                                <label style="font-size: 12px">X:</label>
                                <input
                                    type="number"
                                    id="node-x"
                                    placeholder="X coordinate"
                                    step="1"
                                    style="width: 80px"
                                />
                                <label style="font-size: 12px">Y:</label>
                                <input
                                    type="number"
                                    id="node-y"
                                    placeholder="Y coordinate"
                                    step="1"
                                    style="width: 80px"
                                />
                            </div>
                            <input
                                type="text"
                                id="node-category"
                                placeholder="Category (optional)"
                            />
                            <label>Layers:</label>
                            <input
                                type="text"
                                id="node-layers"
                                placeholder="Enter layers (comma-separated)"
                            />
                            <label>Size:</label>
                            <input
                                type="range"
                                id="node-size"
                                min="1"
                                max="100"
                                value="20"
                                step="1"
                            />
                            <span id="size-display">20</span>
                            <div class="dialog-buttons">
                                <button
                                    id="node-connections-btn"
                                    class="tool-btn"
                                    title="View all connections"
                                >
                                    Connections
                                </button>
                                <button id="node-ok">OK</button>
                                <button id="node-cancel">Cancel</button>
                                <button id="node-delete" class="danger">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="load-dialog" class="dialog hidden">
                        <div class="dialog-content">
                            <h3>Load Database</h3>
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 12px;
                                "
                            >
                                Select a database file to load. Current unsaved
                                changes will be lost.
                            </p>
                            <div
                                id="database-list"
                                style="
                                    max-height: 300px;
                                    overflow-y: auto;
                                    border: 1px solid #ddd;
                                    border-radius: 4px;
                                    padding: 8px;
                                "
                            >
                                <p style="text-align: center; color: #999">
                                    Loading databases...
                                </p>
                            </div>
                            <div
                                id="database-pagination"
                                style="
                                    display: none;
                                    margin-top: 8px;
                                    text-align: center;
                                    font-size: 12px;
                                "
                            >
                                <button
                                    id="pagination-prev"
                                    style="
                                        padding: 6px 16px;
                                        margin: 0 4px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        background: #f9f9f9;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                    "
                                >
                                    ← Prev
                                </button>
                                <span
                                    id="pagination-info"
                                    style="
                                        margin: 0 8px;
                                        color: #666;
                                        font-weight: 500;
                                    "
                                ></span>
                                <span style="margin: 0 4px; color: #666"
                                    >Go to page:</span
                                >
                                <input
                                    type="number"
                                    id="pagination-input"
                                    min="1"
                                    value="1"
                                    style="
                                        width: 50px;
                                        padding: 4px;
                                        margin: 0 4px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        text-align: center;
                                        font-size: 12px;
                                    "
                                />
                                <span
                                    id="pagination-total"
                                    style="margin: 0 4px; color: #666"
                                ></span>
                                <button
                                    id="pagination-go"
                                    style="
                                        padding: 6px 12px;
                                        margin: 0 4px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        background: #f9f9f9;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                    "
                                >
                                    Go
                                </button>
                                <button
                                    id="pagination-next"
                                    style="
                                        padding: 6px 16px;
                                        margin: 0 4px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        background: #f9f9f9;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                    "
                                >
                                    Next →
                                </button>
                            </div>
                            <div class="dialog-buttons">
                                <button id="load-ok">Load</button>
                                <button id="load-cancel">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="save-as-dialog" class="dialog hidden">
                        <div class="dialog-content">
                            <h3>Save As</h3>
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 12px;
                                "
                            >
                                Save current workspace to a new database file.
                            </p>
                            <label>Database filename:</label>
                            <input
                                type="text"
                                id="save-as-filename"
                                placeholder="e.g., my-graph.db"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    margin-bottom: 8px;
                                    border: 1px solid #ddd;
                                    border-radius: 4px;
                                "
                            />
                            <p
                                style="
                                    font-size: 11px;
                                    color: #999;
                                    margin-top: 4px;
                                "
                            >
                                File will be saved in the data/ directory.
                                Include .db extension.
                            </p>
                            <div class="dialog-buttons">
                                <button id="save-as-ok">Save</button>
                                <button id="save-as-cancel">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="node-search-dialog" class="dialog hidden">
                        <div class="dialog-content" style="max-width: 500px">
                            <h3>Search Nodes</h3>
                            <div style="margin-bottom: 12px">
                                <input
                                    type="text"
                                    id="dialog-node-search"
                                    placeholder="Type to search nodes..."
                                    style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 13px;
                                    "
                                />
                                <div
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-top: 8px;
                                    "
                                >
                                    <span
                                        id="dialog-search-count"
                                        style="font-size: 12px; color: #666"
                                        >Start typing to search...</span
                                    >
                                    <button
                                        id="dialog-clear-search-btn"
                                        class="tool-btn"
                                        style="
                                            padding: 4px 8px;
                                            font-size: 12px;
                                        "
                                    >
                                        Clear
                                    </button>
                                </div>
                            </div>
                            <div
                                id="search-results-list"
                                style="
                                    max-height: 300px;
                                    overflow-y: auto;
                                    border: 1px solid #ddd;
                                    border-radius: 4px;
                                    padding: 8px;
                                    margin-bottom: 12px;
                                    background: #f9f9f9;
                                "
                            >
                                <p
                                    style="
                                        text-align: center;
                                        color: #666;
                                        font-size: 12px;
                                        margin: 20px 0;
                                    "
                                >
                                    Start typing to search for nodes...
                                </p>
                            </div>
                            <div
                                id="dialog-pagination"
                                style="
                                    display: none;
                                    justify-content: center;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 12px;
                                    padding: 8px;
                                    background: #f5f5f5;
                                    border-radius: 4px;
                                "
                            >
                                <button
                                    id="dialog-pagination-prev"
                                    class="tool-btn"
                                    style="padding: 6px 12px; font-size: 12px"
                                    disabled
                                >
                                    ← Prev
                                </button>
                                <span
                                    id="dialog-pagination-info"
                                    style="
                                        font-size: 12px;
                                        color: #666;
                                        font-weight: 500;
                                    "
                                ></span>
                                <span style="font-size: 12px; color: #666"
                                    >Go to page:</span
                                >
                                <input
                                    type="number"
                                    id="dialog-pagination-input"
                                    min="1"
                                    style="
                                        width: 60px;
                                        padding: 4px 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 12px;
                                        text-align: center;
                                    "
                                    placeholder="Page"
                                />
                                <button
                                    id="dialog-pagination-go"
                                    class="tool-btn"
                                    style="padding: 6px 12px; font-size: 12px"
                                >
                                    Go
                                </button>
                                <button
                                    id="dialog-pagination-next"
                                    class="tool-btn"
                                    style="padding: 6px 12px; font-size: 12px"
                                    disabled
                                >
                                    Next →
                                </button>
                            </div>
                            <div
                                id="selected-node-info"
                                style="
                                    display: none;
                                    padding: 12px;
                                    background: #f0f0f0;
                                    border-radius: 4px;
                                    margin-bottom: 12px;
                                    font-size: 12px;
                                "
                            >
                                <h4 style="margin-bottom: 8px; font-size: 13px">
                                    Selected Node:
                                </h4>
                                <div id="selected-node-details"></div>
                            </div>
                            <div class="dialog-buttons">
                                <button id="dialog-select-node-btn" disabled>
                                    Select
                                </button>
                                <button id="dialog-search-navigate" disabled>
                                    Navigate
                                </button>
                                <button id="dialog-search-cancel">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="node-connections-dialog" class="dialog hidden">
                        <div class="dialog-content">
                            <h3 id="connections-dialog-title">
                                Node Connections
                            </h3>
                            <div class="connection-count">
                                <strong id="connections-total-count">0</strong>
                                connection(s)
                            </div>
                            <div
                                id="connections-list"
                                style="
                                    max-height: 400px;
                                    overflow-y: auto;
                                    margin-bottom: 12px;
                                "
                            >
                                <!-- Connections will be rendered here -->
                            </div>
                            <div class="dialog-buttons">
                                <button
                                    id="connections-highlight-all-btn"
                                    class="tool-btn"
                                >
                                    Highlight All Connections
                                </button>
                                <button
                                    id="connections-focus-btn"
                                    class="tool-btn"
                                >
                                    Focus on Node
                                </button>
                                <button id="connections-close-btn">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="edge-search-dialog" class="dialog hidden">
                        <div class="dialog-content" style="max-width: 500px">
                            <h3>Create Edge</h3>
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 16px;
                                "
                            >
                                Connect distant nodes via search
                            </p>

                            <!-- Source Node Search -->
                            <div style="margin-bottom: 16px">
                                <label
                                    style="
                                        display: block;
                                        font-size: 13px;
                                        font-weight: 600;
                                        margin-bottom: 6px;
                                    "
                                >
                                    Source Node:
                                </label>
                                <input
                                    type="text"
                                    id="edge-source-search"
                                    placeholder="Search for source node..."
                                    style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 13px;
                                    "
                                />
                                <div
                                    id="edge-source-results"
                                    class="edge-search-dropdown hidden"
                                    style="
                                        max-height: 200px;
                                        overflow-y: auto;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        margin-top: 4px;
                                        background: white;
                                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                                    "
                                ></div>
                                <div
                                    id="edge-source-selected"
                                    style="
                                        font-size: 12px;
                                        color: #666;
                                        margin-top: 4px;
                                        min-height: 16px;
                                    "
                                ></div>
                            </div>

                            <!-- Target Node Search -->
                            <div style="margin-bottom: 16px">
                                <label
                                    style="
                                        display: block;
                                        font-size: 13px;
                                        font-weight: 600;
                                        margin-bottom: 6px;
                                    "
                                >
                                    Target Node:
                                </label>
                                <input
                                    type="text"
                                    id="edge-target-search"
                                    placeholder="Search for target node..."
                                    style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 13px;
                                    "
                                />
                                <div
                                    id="edge-target-results"
                                    class="edge-search-dropdown hidden"
                                    style="
                                        max-height: 200px;
                                        overflow-y: auto;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        margin-top: 4px;
                                        background: white;
                                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                                    "
                                ></div>
                                <div
                                    id="edge-target-selected"
                                    style="
                                        font-size: 12px;
                                        color: #666;
                                        margin-top: 4px;
                                        min-height: 16px;
                                    "
                                ></div>
                            </div>

                            <!-- Weight Input -->
                            <div style="margin-bottom: 16px">
                                <label
                                    style="
                                        display: block;
                                        font-size: 13px;
                                        font-weight: 600;
                                        margin-bottom: 6px;
                                    "
                                >
                                    Weight:
                                </label>
                                <input
                                    type="number"
                                    id="edge-weight-input"
                                    value="1"
                                    min="0.01"
                                    step="0.01"
                                    style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 13px;
                                    "
                                />
                            </div>

                            <!-- Category Input -->
                            <div style="margin-bottom: 16px">
                                <label
                                    style="
                                        display: block;
                                        font-size: 13px;
                                        font-weight: 600;
                                        margin-bottom: 6px;
                                    "
                                >
                                    Category (optional):
                                </label>
                                <input
                                    type="text"
                                    id="edge-category-input"
                                    placeholder="Enter category..."
                                    style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 13px;
                                    "
                                />
                            </div>

                            <div class="dialog-buttons">
                                <button id="edge-search-ok">Create Edge</button>
                                <button id="edge-search-cancel">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="merge-dialog" class="dialog hidden">
                        <div class="dialog-content" style="max-width: 500px">
                            <h3>Merge Database</h3>
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 16px;
                                "
                            >
                                Select a source database to merge into the
                                current database. Choose how to handle
                                conflicts.
                            </p>

                            <!-- Database Selection -->
                            <div style="margin-bottom: 16px">
                                <label
                                    style="
                                        display: block;
                                        font-size: 13px;
                                        font-weight: 600;
                                        margin-bottom: 6px;
                                    "
                                >
                                    Source Database:
                                </label>
                                <div
                                    id="merge-database-list"
                                    style="
                                        max-height: 200px;
                                        overflow-y: auto;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        padding: 8px;
                                        background: #f9f9f9;
                                    "
                                >
                                    <p
                                        style="
                                            text-align: center;
                                            color: #999;
                                            font-size: 12px;
                                        "
                                    >
                                        Loading databases...
                                    </p>
                                </div>
                            </div>

                            <!-- Conflict Resolution -->
                            <div style="margin-bottom: 16px">
                                <label
                                    style="
                                        display: block;
                                        font-size: 13px;
                                        font-weight: 600;
                                        margin-bottom: 8px;
                                    "
                                >
                                    Conflict Resolution:
                                </label>
                                <div
                                    style="
                                        display: flex;
                                        flex-direction: column;
                                        gap: 8px;
                                    "
                                >
                                    <label
                                        style="
                                            font-size: 12px;
                                            display: flex;
                                            align-items: center;
                                            cursor: pointer;
                                        "
                                    >
                                        <input
                                            type="radio"
                                            name="merge-conflict-resolution"
                                            value="skip"
                                            checked
                                            style="margin-right: 8px"
                                        />
                                        <div>
                                            <strong>Skip Conflicts</strong>
                                            (default)
                                            <div
                                                style="
                                                    font-size: 11px;
                                                    color: #666;
                                                    margin-top: 2px;
                                                "
                                            >
                                                Keep existing data, ignore
                                                conflicting items
                                            </div>
                                        </div>
                                    </label>
                                    <label
                                        style="
                                            font-size: 12px;
                                            display: flex;
                                            align-items: center;
                                            cursor: pointer;
                                        "
                                    >
                                        <input
                                            type="radio"
                                            name="merge-conflict-resolution"
                                            value="replace"
                                            style="margin-right: 8px"
                                        />
                                        <div>
                                            <strong>Replace Conflicts</strong>
                                            <div
                                                style="
                                                    font-size: 11px;
                                                    color: #666;
                                                    margin-top: 2px;
                                                "
                                            >
                                                Overwrite existing data with
                                                imported data
                                            </div>
                                        </div>
                                    </label>
                                    <label
                                        style="
                                            font-size: 12px;
                                            display: flex;
                                            align-items: center;
                                            cursor: pointer;
                                        "
                                    >
                                        <input
                                            type="radio"
                                            name="merge-conflict-resolution"
                                            value="rename"
                                            style="margin-right: 8px"
                                        />
                                        <div>
                                            <strong>Rename Conflicts</strong>
                                            <div
                                                style="
                                                    font-size: 11px;
                                                    color: #666;
                                                    margin-top: 2px;
                                                "
                                            >
                                                Create new items with new IDs
                                                for conflicting data
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="dialog-buttons">
                                <button id="merge-ok">Merge</button>
                                <button id="merge-cancel">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar" id="local-graph-sidebar">
                    <div
                        class="resize-handle"
                        id="local-graph-resize-handle"
                    ></div>
                    <div class="sidebar-section">
                        <h3>Graph Info</h3>
                        <div id="graph-info">
                            <p>Nodes: <span id="node-count">0</span></p>
                            <p>Edges: <span id="edge-count">0</span></p>
                            <p>Mode: <span id="current-mode">Node</span></p>
                            <p
                                id="search-count"
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-top: 8px;
                                "
                            >
                                0 nodes
                            </p>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h3>Selected</h3>
                        <div id="selection-info">
                            <p>Nothing selected</p>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h3>Instructions</h3>
                        <div class="instructions">
                            <p>
                                <strong>Node Mode:</strong> Click to create
                                nodes
                            </p>
                            <p>
                                <strong>Edge Mode:</strong> Click two nodes to
                                connect
                            </p>
                            <p>
                                <strong>Select Mode:</strong> Click to
                                select/move nodes
                            </p>
                            <p>
                                <strong>Right-click:</strong> Edit node/edge
                                properties
                            </p>
                            <p>
                                <strong>Drag:</strong> Move nodes or pan canvas
                            </p>
                            <p><strong>Scroll:</strong> Zoom in/out</p>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4>Display Options</h4>
                        <div class="filter-controls">
                            <div style="margin-bottom: 8px">
                                <label
                                    style="
                                        font-size: 11px;
                                        display: flex;
                                        align-items: center;
                                        cursor: pointer;
                                    "
                                >
                                    <input
                                        type="checkbox"
                                        id="show-edge-arrows"
                                        style="margin-right: 6px"
                                    />
                                    Show Edge Arrows
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4>View State</h4>
                        <div style="margin-bottom: 8px">
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 8px;
                                "
                            >
                                Save current zoom and pan position
                            </p>
                            <button
                                id="save-view-state-btn"
                                class="tool-btn"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    font-size: 12px;
                                "
                                title="Save View State"
                            >
                                <i
                                    data-lucide="hard-drive-download"
                                    class="icon"
                                ></i>
                                Save View
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4>Create Edge</h4>
                        <div style="margin-bottom: 8px">
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 8px;
                                "
                            >
                                Connect distant nodes via search
                            </p>
                            <button
                                id="create-edge-search-btn"
                                class="tool-btn"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    font-size: 12px;
                                "
                                title="Create Edge via Search"
                            >
                                <i data-lucide="link-2" class="icon"></i>
                                Create Edge
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4>Database Operations</h4>
                        <div style="margin-bottom: 8px">
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 8px;
                                "
                            >
                                Merge data from another database
                            </p>
                            <button
                                id="merge-db-btn"
                                class="tool-btn"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    font-size: 12px;
                                "
                                title="Merge Database"
                            >
                                <i data-lucide="git-merge" class="icon"></i>
                                Merge Database
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4>Layer Management</h4>
                        <div style="margin-bottom: 8px">
                            <p
                                id="layer-summary"
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 8px;
                                "
                            >
                                No layers defined
                            </p>
                            <button
                                id="manage-layers-btn"
                                class="tool-btn"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    font-size: 12px;
                                "
                                title="Manage Layers"
                            >
                                <i data-lucide="layers" class="icon"></i>
                                Manage Layers
                            </button>
                        </div>
                        <div style="margin-top: 8px">
                            <div style="margin-bottom: 8px">
                                <label
                                    style="
                                        font-size: 11px;
                                        display: block;
                                        margin-bottom: 4px;
                                    "
                                >
                                    Filter Mode:
                                </label>
                                <label
                                    style="
                                        font-size: 11px;
                                        display: flex;
                                        align-items: center;
                                        cursor: pointer;
                                        margin-bottom: 4px;
                                    "
                                >
                                    <input
                                        type="radio"
                                        name="layer-filter-mode"
                                        value="include"
                                        checked
                                        style="margin-right: 6px"
                                    />
                                    Include
                                </label>
                                <label
                                    style="
                                        font-size: 11px;
                                        display: flex;
                                        align-items: center;
                                        cursor: pointer;
                                    "
                                >
                                    <input
                                        type="radio"
                                        name="layer-filter-mode"
                                        value="exclude"
                                        style="margin-right: 6px"
                                    />
                                    Exclude
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4>Templates</h4>
                        <div style="margin-bottom: 8px">
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 8px;
                                "
                            >
                                Start fresh with a template
                            </p>
                            <button
                                id="new-template-btn"
                                class="tool-btn"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    font-size: 12px;
                                "
                                title="New Graph Template"
                            >
                                <i
                                    data-lucide="layout-template"
                                    class="icon"
                                ></i>
                                New Graph Template
                            </button>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <h4>Settings</h4>
                        <div style="margin-bottom: 8px">
                            <p
                                style="
                                    font-size: 12px;
                                    color: #666;
                                    margin-bottom: 8px;
                                "
                            >
                                Customize application preferences
                            </p>
                            <button
                                id="settings-btn"
                                class="tool-btn"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    font-size: 12px;
                                "
                                title="Settings"
                            >
                                <i data-lucide="settings" class="icon"></i>
                                Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layer Management Dialog -->
        <div id="layer-management-dialog" class="dialog hidden">
            <div class="dialog-content" style="max-width: 600px">
                <h3>Manage Layers</h3>
                <div style="margin-bottom: 12px">
                    <input
                        type="text"
                        id="layer-search-input"
                        placeholder="Search layers..."
                        style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 13px;
                        "
                    />
                </div>
                <div style="margin-bottom: 12px">
                    <div style="display: flex; gap: 8px; margin-bottom: 8px">
                        <label
                            style="
                                font-size: 12px;
                                display: flex;
                                align-items: center;
                                cursor: pointer;
                            "
                        >
                            <input
                                type="radio"
                                name="dialog-layer-filter-mode"
                                value="include"
                                checked
                                style="margin-right: 6px"
                            />
                            Include
                        </label>
                        <label
                            style="
                                font-size: 12px;
                                display: flex;
                                align-items: center;
                                cursor: pointer;
                            "
                        >
                            <input
                                type="radio"
                                name="dialog-layer-filter-mode"
                                value="exclude"
                                style="margin-right: 6px"
                            />
                            Exclude
                        </label>
                    </div>
                    <div
                        style="font-size: 12px; color: #666; margin-bottom: 8px"
                    >
                        Total: <span id="total-layers-count">0</span> |
                        Selected: <span id="selected-layers-count">0</span>
                    </div>
                </div>
                <div
                    id="layer-grid"
                    style="
                        max-height: 300px;
                        overflow-y: auto;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        padding: 8px;
                        margin-bottom: 12px;
                        background: #f9f9f9;
                    "
                >
                    <p
                        style="
                            text-align: center;
                            color: #666;
                            font-size: 12px;
                            margin: 20px 0;
                        "
                    >
                        No layers defined
                    </p>
                </div>
                <div
                    id="layer-pagination"
                    style="
                        display: none;
                        justify-content: center;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 12px;
                        flex-wrap: wrap;
                    "
                >
                    <button
                        id="layer-pagination-prev"
                        class="tool-btn"
                        style="padding: 6px 12px; font-size: 12px"
                        disabled
                    >
                        ← Prev
                    </button>
                    <span
                        id="layer-pagination-info"
                        style="font-size: 12px; color: #666; font-weight: 500"
                    ></span>
                    <span style="font-size: 12px; color: #666"
                        >Go to page:</span
                    >
                    <input
                        type="number"
                        id="layer-pagination-input"
                        min="1"
                        style="
                            width: 60px;
                            padding: 4px 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 12px;
                            text-align: center;
                        "
                        placeholder="Page"
                    />
                    <button
                        id="layer-pagination-go"
                        class="tool-btn"
                        style="padding: 6px 12px; font-size: 12px"
                    >
                        Go
                    </button>
                    <button
                        id="layer-pagination-next"
                        class="tool-btn"
                        style="padding: 6px 12px; font-size: 12px"
                    >
                        Next →
                    </button>
                </div>
                <div
                    style="
                        display: flex;
                        gap: 8px;
                        margin-bottom: 8px;
                        flex-wrap: wrap;
                    "
                >
                    <button
                        id="select-all-layers-btn"
                        class="tool-btn"
                        style="padding: 6px 12px; font-size: 12px"
                    >
                        Select All
                    </button>
                    <button
                        id="select-none-layers-btn"
                        class="tool-btn"
                        style="padding: 6px 12px; font-size: 12px"
                    >
                        Select None
                    </button>
                    <button
                        id="invert-selection-btn"
                        class="tool-btn"
                        style="padding: 6px 12px; font-size: 12px"
                    >
                        Invert
                    </button>
                    <button
                        id="save-layer-view-btn"
                        class="tool-btn"
                        style="padding: 6px 12px; font-size: 12px"
                    >
                        Save View
                    </button>
                </div>
                <div class="dialog-buttons">
                    <button id="apply-layers-btn">Apply</button>
                    <button id="reset-layers-btn">Reset</button>
                    <button id="cancel-layers-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Layer Rename Dialog -->
        <div id="layer-rename-dialog" class="dialog hidden">
            <div class="dialog-content" style="max-width: 400px">
                <h3>Rename Layer</h3>
                <div style="margin-bottom: 12px">
                    <label
                        style="
                            font-size: 12px;
                            display: block;
                            margin-bottom: 4px;
                        "
                    >
                        Current Name:
                    </label>
                    <input
                        type="text"
                        id="rename-old-layer"
                        readonly
                        style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 13px;
                            background: #f5f5f5;
                        "
                    />
                </div>
                <div style="margin-bottom: 12px">
                    <label
                        style="
                            font-size: 12px;
                            display: block;
                            margin-bottom: 4px;
                        "
                    >
                        New Name:
                    </label>
                    <input
                        type="text"
                        id="rename-new-layer"
                        placeholder="Enter new layer name"
                        style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 13px;
                        "
                    />
                </div>
                <div
                    id="rename-usage-info"
                    style="font-size: 11px; color: #666; margin-bottom: 8px"
                >
                    This layer is used by 0 node(s)
                </div>
                <div
                    id="rename-error"
                    style="
                        display: none;
                        color: #d32f2f;
                        font-size: 12px;
                        margin-bottom: 8px;
                        padding: 8px;
                        background: #ffebee;
                        border-radius: 4px;
                    "
                ></div>
                <div class="dialog-buttons">
                    <button id="rename-apply-btn">Rename</button>
                    <button id="rename-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Settings Dialog -->
        <div id="settings-dialog" class="dialog hidden">
            <div class="dialog-content" style="max-width: 600px">
                <h3>Settings</h3>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6;">
                    <button
                        id="settings-tab-fonts"
                        class="settings-tab active"
                        data-tab="fonts"
                        style="
                            padding: 8px 16px;
                            border: none;
                            background: transparent;
                            cursor: pointer;
                            font-size: 14px;
                            color: #495057;
                            border-bottom: 2px solid #007bff;
                            margin-bottom: -1px;
                        "
                    >
                        Fonts
                    </button>
                </div>

                <!-- Fonts Tab Content -->
                <div id="settings-content-fonts" class="settings-tab-content">
                    <div style="margin-bottom: 20px">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #495057;">
                            UI Font
                        </h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            Font family for interface elements (toolbar, dialogs, sidebar)
                        </p>
                        <select
                            id="ui-font-family"
                            style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 13px;
                                margin-bottom: 8px;
                            "
                        >
                            <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif">System Default</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica Neue</option>
                            <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Open Sans', sans-serif">Open Sans</option>
                            <option value="'Lato', sans-serif">Lato</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="'Courier New', Courier, monospace">Courier New</option>
                        </select>
                        <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                            Preview: <span id="ui-font-preview" style="font-weight: 500;">The quick brown fox jumps over the lazy dog</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #495057;">
                            Canvas Label Font (English)
                        </h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            Font family for English labels on graph nodes
                        </p>
                        <select
                            id="canvas-font-family"
                            style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 13px;
                                margin-bottom: 8px;
                            "
                        >
                            <option value="Arial">Arial</option>
                            <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica Neue</option>
                            <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Open Sans', sans-serif">Open Sans</option>
                            <option value="'Lato', sans-serif">Lato</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="Verdana, Geneva, sans-serif">Verdana</option>
                            <option value="Tahoma, Geneva, sans-serif">Tahoma</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="'Courier New', Courier, monospace">Courier New</option>
                        </select>
                        <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                            Preview: <span id="canvas-font-preview" style="font-weight: 500;">Node Label</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #495057;">
                            Canvas Label Font (Chinese)
                        </h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            Font family for Chinese labels on graph nodes
                        </p>
                        <select
                            id="canvas-chinese-font-family"
                            style="
                                width: 100%;
                                padding: 8px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 13px;
                                margin-bottom: 8px;
                            "
                        >
                            <option value="Arial">Arial (Default)</option>
                            <option value="'Microsoft YaHei', '微软雅黑', Arial, sans-serif">Microsoft YaHei</option>
                            <option value="'SimHei', '黑体', Arial, sans-serif">SimHei (黑体)</option>
                            <option value="'SimSun', '宋体', Arial, serif">SimSun (宋体)</option>
                            <option value="'KaiTi', '楷体', Arial, serif">KaiTi (楷体)</option>
                            <option value="'FangSong', '仿宋', Arial, serif">FangSong (仿宋)</option>
                            <option value="'PingFang SC', '苹方', Arial, sans-serif">PingFang SC</option>
                            <option value="'Hiragino Sans GB', '冬青黑体', Arial, sans-serif">Hiragino Sans GB</option>
                            <option value="'Noto Sans SC', Arial, sans-serif">Noto Sans SC</option>
                            <option value="'Source Han Sans SC', Arial, sans-serif">Source Han Sans SC</option>
                        </select>
                        <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                            Preview: <span id="canvas-chinese-font-preview" style="font-weight: 500;">中文标签</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #495057;">
                            Canvas Font Size
                        </h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            Base font size for canvas labels (default: 14px)
                        </p>
                        <input
                            type="range"
                            id="canvas-font-size"
                            min="8"
                            max="24"
                            value="14"
                            step="1"
                            style="width: 100%; margin-bottom: 8px;"
                        />
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>8px</span>
                            <span id="canvas-font-size-value" style="font-weight: 600; color: #007bff;">14px</span>
                            <span>24px</span>
                        </div>
                    </div>
                </div>

                <div class="dialog-buttons">
                    <button id="settings-reset-btn">Reset to Defaults</button>
                    <button id="settings-apply-btn">Apply</button>
                    <button id="settings-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Load UI functions -->
        <script src="ui-functions.js"></script>

        <!-- Main Application -->
        <script type="module" src="graph.js"></script>
        <script type="module" src="app.js"></script>
        <!-- Initialize Lucide Icons with fallback -->
        <script>
            // Wait for Lucide to load, then initialize icons
            let initAttempts = 0;
            const maxAttempts = 50; // 5 seconds max wait

            function initializeLucideIcons() {
                initAttempts++;

                if (
                    window.lucide &&
                    typeof window.lucide.createIcons === "function"
                ) {
                    try {
                        lucide.createIcons();
                        console.log("Lucide icons initialized successfully");
                        return;
                    } catch (error) {
                        console.error(
                            "Error initializing Lucide icons:",
                            error,
                        );
                        fallbackToEmojis();
                        return;
                    }
                }

                if (window.lucideUnavailable) {
                    fallbackToEmojis();
                    return;
                }

                // Wait a bit more for script to load (up to max attempts)
                if (initAttempts < maxAttempts) {
                    setTimeout(initializeLucideIcons, 100);
                } else {
                    console.warn(
                        "Lucide icons timed out. Falling back to emojis.",
                    );
                    fallbackToEmojis();
                }
            }

            function fallbackToEmojis() {
                // Map Lucide icon names to emojis
                const emojiMap = {
                    x: "✕",
                    search: "🔍",
                    save: "💾",
                    "hard-drive-download": "💾",
                    "undo-2": "↶",
                    "circle-dot": "⚫",
                    link: "🔗",
                    "link-2": "🔗",
                    "mouse-pointer-2": "👆",
                    command: "⌨️",
                    "folder-open": "📂",
                    "trash-2": "🗑️",
                    "rotate-cw": "↺",
                    "git-merge": "🔗",
                    layers: "📋",
                    "layout-template": "📄",
                    settings: "⚙️",
                };

                // Replace all Lucide icons with emojis
                document
                    .querySelectorAll("[data-lucide]")
                    .forEach(function (el) {
                        const iconName = el.getAttribute("data-lucide");
                        const emoji = emojiMap[iconName] || "•";
                        const span = document.createElement("span");
                        span.className = "icon";
                        span.textContent = emoji;
                        el.parentNode.replaceChild(span, el);
                    });

                console.log("Fell back to emoji icons");
            }

            // Start initialization after DOM is ready
            if (document.readyState === "loading") {
                document.addEventListener(
                    "DOMContentLoaded",
                    initializeLucideIcons,
                );
            } else {
                // Small delay to ensure scripts are loaded
                setTimeout(initializeLucideIcons, 50);
            }
        </script>
    </body>
</html>
